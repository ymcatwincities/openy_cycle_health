<template>
  <div>
    <Greeting
      :login-required="true"
      :name-modal-visible="nameModalVisible"
      v-on:show-greeting-modal="nameModalVisible = true"
      v-on:hide-greeting-modal="nameModalVisible = false"
    ></Greeting>

    <ExerciseModal
      :exercise="currentExercise"
      :exercise-modal-visible="exerciseModalVisible"
      :is-exercise-finished="isExerciseFinished"
      :on-exercise-finished="onExerciseFinished"
      :on-exercise-closed="onExerciseClosed"
      :debug="debug"
    ></ExerciseModal>

    <ExerciseList
      :exercise-list="exercise_list"
      :is-exercise-finished="isExerciseFinished"
      :on-exercise-selected="onExerciseSelected"
      :disabled="nameModalVisible || exerciseModalVisible"
    ></ExerciseList>

    <notifications group="twelve_app"></notifications>
  </div>
</template>

<script>
  import Greeting from '../components/Greeting.vue';
  import ExerciseModal from '../components/ExerciseModal.vue';
  import ExerciseList from './components/ExerciseList.vue';
  import Spinner from '../components/Spinner.vue'
  import twelve from '../helper/twelve';

  export default {
    components: {
      Greeting,
      ExerciseModal,
      ExerciseList,
      Spinner,
    },
    props: [
      'debug', 'error_message', 'game_nid', 'progress_nid', 'exercise_list',
      'finished_exercises', 'completion_url', 'badges_list'
    ],
    data() {
      twelve.local_storage.save_today_progress(this.$props.progress_nid, this.$props.finished_exercises);
      return {
        currentExercise: {},
        exerciseModalVisible: false,
        nameModalVisible: false,
        isStepNextDisabled: true
      };
    },
    created: function () {
      twelve.local_storage.set_user_name(twelve.user.get_active_player_name());

      if (this.$props.finished_exercises.length === 0) {
        let cache = twelve.local_storage.load_today_progress(this.$props.progress_nid);
        for (let index = 0; index < cache.length; index++) {
          this.$props.finished_exercises.push(cache[index]);
        }
      }
    },
    methods: {
      onExerciseSelected: function (exercise) {
        if (this.isExerciseFinished(exercise)) {
          return;
        }

        this.currentExercise = exercise;
        this.exerciseModalVisible = true;
      },
      onExerciseClosed: function () {
        this.exerciseModalVisible = false;

        if (this.fullyCompletedTodayExercises()) {
          window.location = window.location.origin + '/user';
        }
      },
      isExerciseFinished: function(exercise) {
        return this.$props.finished_exercises.includes(exercise.id);
      },
      onExerciseFinished(exercise) {
        this.$props.finished_exercises.push(exercise.id);
        this.beep();

        twelve.local_storage.save_today_progress(this.$props.progress_nid, Array.from(this.$props.finished_exercises.values()));
        twelve.send_progress(
          this.$props.game_nid,
          this.$props.progress_nid,
          this.$props.finished_exercises,
        );

        this.$notify({
          group: 'twelve_app',
          title: 'Hooray, you have finished your exercise!',
          text: 'Now, lets have some rest.'
        });

        if (this.fullyCompletedTodayExercises()) {
          twelve.user.badge.create_hidden_image(this.$props.badges_list, this.$props.game_nid);
        }
      },
      beep: function () {
        let snd = new Audio('/modules/custom/twelve_app/assets/disco_alarm.wav');
        snd.play();
      },
      fullyCompletedTodayExercises: function () {
        return (this.$props.finished_exercises.length >= Object.keys(this.$props.exercise_list).length);
      },
    },
  }
</script>
